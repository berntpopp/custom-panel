# Running the Pipeline

Learn how to use Custom Panel's command-line interface to create gene panels.

## Command Options

Custom Panel can be run in two ways:

- **Make commands (recommended)**: `make run ARGS="..."`
- **Direct commands**: `uv run custom-panel ...`

Make commands provide a consistent development workflow and are the recommended approach.

## Quick Start

### 1. Basic Pipeline Run

Run the complete pipeline with default settings:

```bash
# Using Make (recommended)
make run ARGS="run --output-dir results"

# Or directly
uv run custom-panel run --output-dir results
```

This will:
- Fetch data from all enabled sources
- Merge and score genes using the default configuration
- Generate output files in multiple formats

### 2. Check Configuration

Before running, verify your configuration:

```bash
# Using Make
make config-check

# Or directly
uv run custom-panel config-check
```

### 3. Search Available Panels

Find relevant panels in PanelApp:

```bash
# Using Make
make run ARGS="search-panels cancer"

# Or directly
uv run custom-panel search-panels "cancer"
```

## Main Commands

### `run` - Execute the Complete Pipeline

```bash
custom-panel run [OPTIONS]
```

**Key Options:**
- `-c, --config-file TEXT` - Custom configuration file
- `-o, --output-dir TEXT` - Output directory (default: results)
- `--score-threshold FLOAT` - Override score threshold
- `--log-level TEXT` - Log level (DEBUG, INFO, WARNING, ERROR)
- `--dry-run` - Preview what would be executed

**Examples:**

```bash
# Basic run with custom output directory
make run ARGS="run --output-dir my_results"
# Or: uv run custom-panel run --output-dir my_results

# Use custom configuration  
make run ARGS="run -c my_config.yml --output-dir results"
# Or: uv run custom-panel run -c my_config.yml --output-dir results

# Debug mode with lower threshold
make run ARGS="run --log-level DEBUG --score-threshold 1.0"
# Or: uv run custom-panel run --log-level DEBUG --score-threshold 1.0

# Preview mode (no files created)
make run ARGS="run --dry-run"  
# Or: uv run custom-panel run --dry-run
```

### `fetch` - Fetch Data from Individual Sources

```bash
custom-panel fetch SOURCE [OPTIONS]
```

**Available Sources:**
- `panelapp` - UK Genomics England PanelApp
- `inhouse` - Local gene panel files
- `acmg` - ACMG incidental findings
- `manual` - Manual curation lists
- `hpo` - HPO/OMIM neoplasm genes
- `cosmic` - COSMIC Cancer Gene Census
- `clingen` - ClinGen gene validity
- `gencc` - GenCC gene-disease associations
- `commercial` - Commercial panel data

**Examples:**

```bash
# Fetch PanelApp data only
make run ARGS="fetch panelapp --output-dir results/panelapp"
# Or: uv run custom-panel fetch panelapp --output-dir results/panelapp

# Fetch with specific format
make run ARGS="fetch acmg --format csv --output-dir results"
# Or: uv run custom-panel fetch acmg --format csv --output-dir results
```

## Output Files

The pipeline generates several output formats:

### Final Panel Files
- `master_panel.xlsx` - Comprehensive Excel file with all data
- `master_panel.csv` - CSV format for programmatic use
- `master_panel.parquet` - Efficient binary format
- `germline_panel.bed` - BED file for included genes
- `panel_report.html` - Interactive HTML report with charts and export functionality

### Intermediate Files (if enabled)
- Raw source data
- Standardized data
- Merged data before scoring
- Scored data before final filtering

## Configuration Options

### Score Thresholds

Adjust inclusion criteria:

```bash
# Lower threshold for more genes
make run ARGS="run --score-threshold 1.0"
# Or: uv run custom-panel run --score-threshold 1.0

# Higher threshold for stricter filtering  
make run ARGS="run --score-threshold 2.5"
# Or: uv run custom-panel run --score-threshold 2.5
```

### Output Formats

Control which formats are generated by editing your configuration file:

```yaml
output:
  formats:
    - "excel"    # Comprehensive Excel file
    - "csv"      # CSV for programmatic use
    - "parquet"  # Efficient binary format
    - "bed"      # BED files for genome browsers
```

### Logging

Enable detailed logging:

```bash
# Debug mode
make run ARGS="run --log-level DEBUG"
# Or: uv run custom-panel run --log-level DEBUG

# Save logs to files  
make run ARGS="run --log-to-file"
# Or: uv run custom-panel run --log-to-file
```

## Advanced Usage

### Custom Configuration

Create a custom configuration file:

```bash
cp custom_panel/config/default_config.yml my_config.yml
# Edit my_config.yml as needed
make run ARGS="run -c my_config.yml"
# Or: uv run custom-panel run -c my_config.yml
```

### Batch Processing

Process multiple configurations:

```bash
#!/bin/bash
for config in configs/*.yml; do
    output_dir="results/$(basename $config .yml)"
    make run ARGS="run -c $config --output-dir $output_dir"
    # Or: uv run custom-panel run -c "$config" --output-dir "$output_dir"
done
```

### Performance Tuning

Adjust performance settings in your configuration:

```yaml
performance:
  max_workers: 4      # Parallel workers for API calls
  batch_size: 300     # Genes per batch for coordinate lookup
  enable_caching: true # Cache API responses
```

## Next Steps

- **[Configuration Guide](./configuration.md)** - Customize scoring and data sources
- **[HTML Reports](./html_reports.md)** - Learn about interactive web reports
- **[Data Source Setup](./cosmic_setup.md)** - Configure external data access
- **[API Reference](../api/cli.md)** - Complete CLI documentation